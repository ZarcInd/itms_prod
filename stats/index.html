<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Device Status Dashboard</title>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let base = document.createElement("base");
        base.href =
          window.location.protocol + "//" + window.location.host + "/stats/";
        document.head.appendChild(base);
      });
    </script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      .table-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
      }
      label {
        font-weight: bold;
      }
      thead {
        position: sticky;
        top: 0;
        background-color: #343a40;
        color: white;
      }
      .loader {
        display: none;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
      }
      .spinner-border {
        width: 2rem;
        height: 2rem;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="mb-4 text-center">Device Status Dashboard</h2>

      <div class="row mb-3">
        <!-- Date Filter -->
        <div class="col-md-4">
          <label for="dateFilter" class="form-label">Select Date:</label>
          <input type="date" id="dateFilter" class="form-control" />
        </div>

        <!-- Device ID Search (Frontend filtering only) -->
        <div class="col-md-4">
          <label for="deviceID" class="form-label">Device ID:</label>
          <input
            type="text"
            id="deviceID"
            class="form-control"
            placeholder="Enter Device ID"
          />
        </div>
      </div>

      <!-- Loader Animation -->
      <div class="loader" id="loading">
        <span>Loading Data...</span>
        <div class="spinner-border text-primary"></div>
      </div>

      <!-- Device Status Table -->
      <div class="table-container">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
                <th>S.No</th>
              <th>Device ID</th>
              <th>Active Hours</th>
              <th>Total Packets Received</th>
              <th>LP/SP Packets</th>
              <th>SO Packets</th>
              <th>Expected Packets</th>
              <th>Efficiency</th>
              <th>First Packet</th>
              <th>Last Packet</th>
            </tr>
          </thead>
          <tbody id="dataTable">
            <tr>
              <td colspan="8" class="text-center">No data available</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Calculated Results -->
      <div class="mt-3">
        <h5>Statistics:</h5>
        <p>
          <strong>Average Efficiency:</strong>
          <span id="avgEfficiency">N/A</span> %
        </p>
        <p><strong>Average Packets:</strong> <span id="avgPkts">N/A</span></p>
        <p>
          <strong>Average Active Hours:</strong>
          <span id="avgActiveHours">N/A</span>
        </p>
      </div>
    </div>

    <script>
      function getISTDate() {
        const nowUtc = new Date();
        const istOffset = 330 * 60000; // 330 minutes * 60 seconds * 1000 milliseconds
        const nowIst = new Date(nowUtc.getTime() + istOffset);

        const year = nowIst.getFullYear();
        const month = String(nowIst.getMonth() + 1).padStart(2, "0"); // Months are 0-indexed
        const day = String(nowIst.getDate()).padStart(2, "0");

        return `${year}-${month}-${day}`;
      }

      $(document).ready(function () {
        let today = getISTDate();
        $("#dateFilter").val(today);

        let allData = [];

        function fetchData(date, showLoader) {
          if (showLoader) {
            // Show Loader
            $("#loading").show();
          }

          $.ajax({
            url: "backend.php",
            type: "GET",
            data: { date: date }, // Only filter by date, not by device ID
            dataType: "json",
            success: function (response) {
              allData = response;
              filterData();
            },
            complete: function () {
              if (showLoader) {
                $("#loading").hide();
              }
            },
          });
        }

        function filterData() {
          let tableBody = $("#dataTable");
          tableBody.empty();

          let searchID = $("#deviceID").val().trim();
          let filteredData = searchID
            ? allData.filter((item) =>
                item.device_id.toString().includes(searchID)
              )
            : allData;

          if (filteredData.length > 0) {
            let totalPkts = 0,
              totalEfficiency = 0,
              totalActiveHours = 0;

            filteredData.forEach((data, index ) => {
              tableBody.append(`
                    <tr>
                     <td>${index + 1}</td>
                        <td>${data.device_id}</td>
                        <td>${data.active_hours}</td>
                        <td>${data.total_pkts}</td>
                        <td>${data.oth_pkts}</td>
                        <td>${data.so_pkts}</td>
                        <td>${data.expected_pkts}</td>
                        <td>${data.efficiency}</td>
                        <td>${data.first_pkt}</td>
                        <td>${data.last_pkt}</td>
                    </tr>
                `);

              totalPkts += parseFloat(data.total_pkts);
              totalEfficiency += parseFloat(data.efficiency);
              totalActiveHours += parseFloat(data.active_hours);
            });

            let count = filteredData.length;
            $("#avgPkts").text((totalPkts / count).toFixed(2));
            $("#avgEfficiency").text((totalEfficiency / count).toFixed(2));
            $("#avgActiveHours").text((totalActiveHours / count).toFixed(2));
          } else {
            tableBody.append(
              '<tr><td colspan="8" class="text-center">No data available</td></tr>'
            );
            $("#avgTemp, #avgHumidity, #avgBattery").text("N/A");
          }
        }

        // Fetch data when date changes
        $("#dateFilter").change(function () {
          fetchData($(this).val(), true);
        });

        // Filter data on device ID input (without making a backend request)
        $("#deviceID").on("input", function () {
          filterData();
        });

        // Initial Load
        fetchData(today, true);

        // Auto-refresh every 10 seconds
        setInterval(function () {
          fetchData($("#dateFilter").val(), false);
        }, 10000);
      });
    </script>
  </body>
</html>
